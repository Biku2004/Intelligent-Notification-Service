generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// 1. USER & AUTHENTICATION
// ========================================
model User {
  id              String   @id @default(uuid())
  email           String   @unique
  username        String   @unique
  name            String?
  bio             String?
  avatarUrl       String?
  password        String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  preferences     NotificationPreference?
  posts           Post[]
  comments        Comment[]
  likes           Like[]
  following       Follow[] @relation("UserFollowing")
  followers       Follow[] @relation("UserFollowers")
  bellSubscriptions BellSubscription[] @relation("UserBellSubscriptions")
  bellSubscribedBy  BellSubscription[] @relation("TargetUserBellSubscriptions")
  notifications   NotificationHistory[]
}

// ========================================
// 2. NOTIFICATION PREFERENCES
// ========================================
model NotificationPreference {
  id              String  @id @default(uuid())
  userId          String  @unique
  user            User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  emailEnabled    Boolean @default(true)
  smsEnabled      Boolean @default(false)
  pushEnabled     Boolean @default(true)
  marketing       Boolean @default(false)
  activity        Boolean @default(true)
  social          Boolean @default(true)
  dndEnabled      Boolean @default(false)
  dndStartTime    String?
  dndEndTime      String?
  updatedAt       DateTime @updatedAt
}

// ========================================
// 3. SOCIAL FEATURES
// ========================================
model Post {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  caption         String?
  imageUrl        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  comments        Comment[]
  likes           Like[]
  
  @@index([userId])
  @@index([createdAt])
}

model Comment {
  id              String   @id @default(uuid())
  postId          String
  post            Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content         String
  gifUrl          String?
  parentId        String?
  parent          Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies         Comment[] @relation("CommentReplies")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([postId])
  @@index([userId])
  @@index([parentId])
}

model Like {
  id              String   @id @default(uuid())
  postId          String
  post            Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  
  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model Follow {
  id              String   @id @default(uuid())
  followerId      String
  follower        User     @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  followingId     String
  following       User     @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  
  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// ========================================
// 4. BELL ICON SUBSCRIPTION
// ========================================
model BellSubscription {
  id              String   @id @default(uuid())
  subscriberId    String
  subscriber      User     @relation("UserBellSubscriptions", fields: [subscriberId], references: [id], onDelete: Cascade)
  targetUserId    String
  targetUser      User     @relation("TargetUserBellSubscriptions", fields: [targetUserId], references: [id], onDelete: Cascade)
  enabled         Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([subscriberId, targetUserId])
  @@index([subscriberId])
  @@index([targetUserId])
}

// ========================================
// 5. NOTIFICATION HISTORY
// ========================================
model NotificationHistory {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type            String
  priority        String
  actorId         String?
  actorName       String?
  actorAvatar     String?
  isAggregated    Boolean  @default(false)
  aggregatedCount Int      @default(1)
  aggregatedIds   String[]
  title           String
  message         String
  imageUrl        String?
  targetType      String?
  targetId        String?
  isRead          Boolean  @default(false)
  readAt          DateTime?
  deliveryStatus  String   @default("PENDING")
  channels        String[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId, createdAt])
  @@index([userId, isRead])
  @@index([priority])
}
