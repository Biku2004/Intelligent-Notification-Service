// Shared Prisma Schema
// This schema is shared across multiple services
// Location: backend/processing-service/prisma/schema.prisma
// 
// To generate Prisma client in this service, run:
// npx prisma generate --schema=../processing-service/prisma/schema.prisma
//
// Or use the npm script:
// npm run prisma:generate

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// 1. USER & AUTHENTICATION
// ========================================
model User {
  id              String   @id @default(uuid())
  email           String   @unique
  username        String   @unique
  name            String?
  bio             String?
  avatarUrl       String?
  password        String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  preferences     NotificationPreference?
  posts           Post[]
  comments        Comment[]
  likes           Like[]
  following       Follow[] @relation("UserFollowing")
  followers       Follow[] @relation("UserFollowers")
  bellSubscriptions BellSubscription[] @relation("BellSubscriber")
  bellSubscribers   BellSubscription[] @relation("BellTarget")
  notifications   NotificationHistory[]
}

// ========================================
// 2. POSTS
// ========================================
model Post {
  id              String   @id @default(uuid())
  userId          String
  caption         String?
  imageUrl        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments        Comment[]
  likes           Like[]
}

// ========================================
// 3. COMMENTS
// ========================================
model Comment {
  id              String   @id @default(uuid())
  postId          String
  userId          String
  content         String
  parentId        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  post            Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent          Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies         Comment[] @relation("CommentReplies")
}

// ========================================
// 4. LIKES
// ========================================
model Like {
  id              String   @id @default(uuid())
  postId          String
  userId          String
  createdAt       DateTime @default(now())
  
  post            Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([postId, userId])
}

// ========================================
// 5. FOLLOWS
// ========================================
model Follow {
  id              String   @id @default(uuid())
  followerId      String
  followingId     String
  createdAt       DateTime @default(now())
  
  follower        User     @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  following       User     @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)
  
  @@unique([followerId, followingId])
}

// ========================================
// 6. BELL SUBSCRIPTIONS (Post Notifications)
// ========================================
model BellSubscription {
  id              String   @id @default(uuid())
  subscriberId    String
  targetUserId    String
  createdAt       DateTime @default(now())
  
  subscriber      User     @relation("BellSubscriber", fields: [subscriberId], references: [id], onDelete: Cascade)
  targetUser      User     @relation("BellTarget", fields: [targetUserId], references: [id], onDelete: Cascade)
  
  @@unique([subscriberId, targetUserId])
}

// ========================================
// 7. NOTIFICATION HISTORY
// ========================================
model NotificationHistory {
  id              String   @id @default(uuid())
  userId          String
  type            String
  priority        String
  isAggregated    Boolean  @default(false)
  aggregatedCount Int      @default(1)
  title           String
  message         String
  isRead          Boolean  @default(false)
  channels        String[]
  metadata        Json?
  createdAt       DateTime @default(now())
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ========================================
// 8. NOTIFICATION PREFERENCES
// ========================================
model NotificationPreference {
  id              String   @id @default(uuid())
  userId          String   @unique
  
  // Channel preferences
  emailEnabled    Boolean  @default(true)
  smsEnabled      Boolean  @default(false)
  pushEnabled     Boolean  @default(true)
  
  // Do Not Disturb
  dndEnabled      Boolean  @default(false)
  dndStartTime    String?  // HH:mm format
  dndEndTime      String?  // HH:mm format
  
  // Contact info
  email           String?
  phone           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
