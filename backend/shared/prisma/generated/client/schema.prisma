// ========================================
// MASTER SHARED PRISMA SCHEMA
// ========================================
// Single source of truth for all backend services
// All services reference this schema to ensure consistency
//
// Usage: npx prisma generate --schema=backend/shared/prisma/schema.prisma
// ========================================

generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// 1. USER & AUTHENTICATION
// ========================================
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  username  String   @unique
  name      String?
  bio       String?
  avatarUrl String?
  password  String // bcrypt hashed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  preferences NotificationPreference?
  posts       Post[]
  comments    Comment[]
  likes       Like[]
  bookmarks   Bookmark[]

  // Follow relationships
  following Follow[] @relation("UserFollowing")
  followers Follow[] @relation("UserFollowers")

  // Bell subscriptions (YouTube-style)
  bellSubscriptions BellSubscription[] @relation("UserBellSubscriptions")
  bellSubscribedBy  BellSubscription[] @relation("TargetUserBellSubscriptions")

  // Notification history
  notifications NotificationHistory[]
}

// ========================================
// 2. NOTIFICATION PREFERENCES
// ========================================
model NotificationPreference {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Channels
  emailEnabled Boolean @default(true)
  smsEnabled   Boolean @default(false)
  pushEnabled  Boolean @default(true)

  // Categories (Arpit's Logic)
  marketing Boolean @default(false)
  activity  Boolean @default(true)
  social    Boolean @default(true)

  // Do Not Disturb (DND)
  dndEnabled   Boolean @default(false)
  dndStartTime String? // "22:00"
  dndEndTime   String? // "08:00"

  // Contact info
  email String?
  phone String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ========================================
// 3. SOCIAL FEATURES (Instagram-like)
// ========================================

model Post {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  caption   String?
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  comments  Comment[]
  likes     Like[]
  bookmarks Bookmark[]

  @@index([userId])
  @@index([createdAt])
}

model Comment {
  id     String @id @default(uuid())
  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  content String
  gifUrl  String? // Giphy GIF URL

  // Nested replies (self-referential)
  parentId String?
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentReplies")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([postId])
  @@index([userId])
  @@index([parentId])
}

model Like {
  id     String @id @default(uuid())
  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model Bookmark {
  id     String @id @default(uuid())
  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([postId, userId])
  @@index([userId])
  @@index([postId])
}

model Follow {
  id         String @id @default(uuid())
  followerId String
  follower   User   @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)

  followingId String
  following   User   @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// ========================================
// 4. BELL ICON SUBSCRIPTION (YouTube-style)
// ========================================
model BellSubscription {
  id           String @id @default(uuid())
  subscriberId String
  subscriber   User   @relation("UserBellSubscriptions", fields: [subscriberId], references: [id], onDelete: Cascade)

  targetUserId String // User being subscribed to
  targetUser   User   @relation("TargetUserBellSubscriptions", fields: [targetUserId], references: [id], onDelete: Cascade)

  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([subscriberId, targetUserId])
  @@index([subscriberId])
  @@index([targetUserId])
}

// ========================================
// 5. NOTIFICATION HISTORY (PostgreSQL)
// ========================================
model NotificationHistory {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type     String // LIKE, COMMENT, FOLLOW, BELL_POST, etc.
  priority String // CRITICAL, HIGH, LOW

  // Actor (who triggered the notification)
  actorId     String?
  actorName   String?
  actorAvatar String?

  // Aggregation
  isAggregated    Boolean  @default(false)
  aggregatedCount Int      @default(1)
  aggregatedIds   String[] // Array of actor IDs

  // Content
  title    String
  message  String
  imageUrl String?

  // Deep link
  targetType String? // POST, COMMENT, USER
  targetId   String?

  // Status
  isRead Boolean   @default(false)
  readAt DateTime?

  // Delivery status
  deliveryStatus String   @default("PENDING") // PENDING, SENT, FAILED
  channels       String[] // ["PUSH", "EMAIL", "SMS"]

  // Extra metadata
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([userId, isRead])
  @@index([priority])
}

// ========================================
// 6. KAFKA FALLBACK QUEUE (P1 Reliability)
// ========================================
// Stores notification events when Kafka is unavailable
// A recovery job processes these when Kafka is back online
model KafkaFallbackQueue {
  id String @id @default(uuid())

  // Event data
  eventData String // JSON stringified NotificationEvent
  topic     String // Target Kafka topic
  priority  String // CRITICAL, HIGH, LOW
  targetId  String // Target user ID

  // Status
  processed   Boolean   @default(false)
  processedAt DateTime?

  // Retry tracking
  retryCount  Int       @default(0)
  lastRetryAt DateTime?
  lastError   String?

  createdAt DateTime @default(now())

  @@index([processed, retryCount])
  @@index([createdAt])
  @@index([targetId])
}

// ========================================
// 7. SYSTEM METADATA (JSON storage for extra fields)
// ========================================
model NotificationMetadata {
  id             String   @id @default(uuid())
  notificationId String   @unique
  metadata       String // JSON stringified metadata
  createdAt      DateTime @default(now())
}
